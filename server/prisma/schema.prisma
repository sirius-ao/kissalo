
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CUSTOMER
  PROFESSIONAL
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ProfessionalType {
  ENTERPRISE
  INDIVIDUAL
}

enum ServicePriceType {
  FIXED
  HOURLY
}

enum ServiceLocation {
  CLIENT_HOME
  PROFESSIONAL_HOME
  PROFESSIONAL_SPACE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  STARTED
  COMPLETED
  CANCELED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
}

enum NotificationType {
  BOOKING
  REVIEW
  SYSTEM
  ALERT
  PAYMENT
  AUTH
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
}

enum BookingPriority {
  HIGH
  MEDIUM
  LOW
}

enum VerificationType {
  ACCOUNT_VERIFICATION
  PASSWORD_RESET
  PROFESSIONAL_DOCUMENTS
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}


model User {
  id                Int        @id @default(autoincrement())
  firstName         String
  lastName          String
  email             String     @unique
  phone             String     @unique
  password          String
  avatarUrl         String?
  role              UserRole   @default(CUSTOMER)
  status            UserStatus @default(ACTIVE)
  isEmailVerified   Boolean    @default(false)
  lastLoginAt       DateTime?
  stats             Json?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  professional      Professional?
  notifications     Notification[]
  bookings          Booking[]        @relation("ClientBookings")
  reviews           Review[]
  payments          Payment[]
  verifications     Verification[]

  @@index([email])
  @@index([phone])
  @@index([role, status])
}


model Verification {
  id          Int              @id @default(autoincrement())
  userId      Int
  type        VerificationType
  token       String           @unique
  isUsed      Boolean          @default(false)
  metaData    Json?
  
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([type, isUsed])
}

model Professional {
  id                 Int               @id @default(autoincrement())
  userId             Int               @unique
  type               ProfessionalType
  autoSelect Boolean @default(false)
  title              String?
  description        String?
  documentNumber     String
  yearsExperience    Int
  isVerified         Boolean           @default(false)
  verificationStatus ApprovalStatus    @default(PENDING)
  averageRating      Float             @default(0)
  specialties        String[]
  certifications     String[]
  portfolioUrl       String?
  coverUrl           String?
  cvUrl              String?
  contacts           String[]
  socialMedia        Json?
  stats              Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceRequests    ProfessionalServiceRequest[]
  bookings           Booking[]         @relation("ProfessionalBookings")
  wallets            Wallet[]
  reviews            Review[]
  payments           Payment[]
  docs ProfessionalDocument[]
}

model ProfessionalDocument {
  id               Int             @id @default(autoincrement())
  professionalId   Int
  type             String
  fileUrl          String
  status           ApprovalStatus  @default(PENDING)
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  professional     Professional   @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  @@index([professionalId, status])
}


model Category {
  id          Int        @id @default(autoincrement())
  title       String
  slug        String     @unique
  description String?
  color       String?
  order       Int        @default(0)
  isActive    Boolean    @default(true)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  services      ServiceTemplate[]
}


model ServiceTemplate {
  id            Int              @id @default(autoincrement())
  categoryId    Int
  title            String
  shortDescription String?     
  description      String        
  deliverables     String?       
  slug             String         @unique
  keywords         String[]   
  requirements     String[]
  gallery          String[]       @default([])
  videoUrl         String?
  bannerUrl        String?
  isNegotiable     Boolean        @default(false)
  requiresApproval Boolean        @default(false)
  basePrice        Int
  minPrice         Int?
  maxPrice         Int?
  priceType        ServicePriceType
  currency         String         @default("AOA")
  duration         Int
  isActive         Boolean        @default(true)
  isFeatured       Boolean        @default(false)
  maxRequestsPerDay Int?
  maxBookings      Int?
  viewsCount       Int            @default(0)
  bookingsCount    Int            @default(0)
  ratingAverage    Float          @default(0)
  ratingCount      Int            @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  category      Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  requests      ProfessionalServiceRequest[]
  bookings      Booking[]

  @@index([categoryId])
  @@index([isActive])
  @@index([priceType])
}

model ProfessionalServiceRequest {
  id               Int             @id @default(autoincrement())
  professionalId   Int
  serviceId        Int
  status           ApprovalStatus  @default(PENDING)
  adminNotes       String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  professional     Professional    @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service          ServiceTemplate @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  @@unique([professionalId, serviceId])
  @@index([status])
}

model Booking {
  id               Int             @id @default(autoincrement())
  bookingCode      String          @unique
  clientId         Int
  professionalId   Int?
  serviceId        Int
  scheduleDate     DateTime
  startTime        DateTime
  endTime          DateTime
  location         ServiceLocation
  address          Json
  priority         BookingPriority @default(MEDIUM)
  status           BookingStatus   @default(PENDING)
  paymentStatus    PaymentStatus   @default(PENDING)
  totalAmount      Int
  clientNotes      String?
  professionalNotes String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  client           User            @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  professional     Professional?   @relation("ProfessionalBookings", fields: [professionalId], references: [id], onDelete: SetNull)
  service          ServiceTemplate @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  payment          Payment?
  review           Review?

  @@index([clientId])
  @@index([professionalId])
  @@index([status, paymentStatus])
}

model Payment {
  id             Int           @id @default(autoincrement())
  bookingId      Int           @unique
  clientId       Int
  professionalId Int?
  amount         Int
  currency       String
  method         String
  status         PaymentStatus @default(PENDING)
  paidAt         DateTime?
  refundedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  booking        Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client         User          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  professional   Professional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)
}

model Wallet {
  id               Int        @id @default(autoincrement())
  professionalId   Int
  bankName         String
  accountNumber    String     @unique
  accountHolder    String
  isActive         Boolean    @default(true)
  isVerified       Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  professional     Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
}

model Review {
  id               Int        @id @default(autoincrement())
  bookingId        Int        @unique
  clientId         Int
  professionalId   Int
  rating           Int
  comment          String?
  professionalReply String?
  repliedAt        DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  booking          Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client           User       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  professional     Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
}

model Notification {
  id          Int                  @id @default(autoincrement())
  userId      Int
  type        NotificationType
  channel     NotificationChannel
  title       String
  message     String
  deepLink    String?
  isRead      Boolean              @default(false)
  createdAt   DateTime             @default(now())
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, isRead])
  @@index([type])
}